<script setup>
import ChounnatDetail from './detail/ChounnatDetail.vue';
import KhmerDictionaryDetail from './detail/KhmerDictionaryDetail.vue';
</script>

<script>
import DictionaryController from '../../db/DictionaryController';
import BookmarkController from '@/db/BookmarkController';
const remote = window.require('@electron/remote');
export default {
    name:'DictionaryView',
    data() {
        const self = this
        return {
          tab: 'first',
          search: '',
          checkBookmark: false,
          chounnatDetail: null,
          khmerDcitionaryDetail: null,
          loading: false,
          input_menu_template:
          [
            {
              label: 'Copy',
              id: 'copy',
              click: function () {
                const selectedText = window.getSelection();
                const text = selectedText.toString();
                if(text.length > 0){
                  remote.clipboard.writeText(text);
                }
              }
            },
            {
              label: 'Paste',
              id: 'paste',
              click: function () {
                const text = remote.clipboard.readText()
                self.search  = text;
                DictionaryController.onSearch(self.search);
              }
            },
            {
              label: 'Select All',
              id: 'selectAll',
              click: function () {
                let inputEl = self.$refs.searchInput.$el.querySelector('input')
                if(inputEl){
                  inputEl.select();
                }
              }
            }
          ],
          definition_menu_template:
          [
            {
              label: 'Copy',
              id: 'copy',
              click: function () {
                const selectedText = window.getSelection();
                const text = selectedText.toString();
                if(text.length > 0){
                  remote.clipboard.writeText(text);
                }
              }
            }
          ]
        }
    },
    mounted() {
      DictionaryController.query();
      this.input_menu = remote.Menu.buildFromTemplate(this.input_menu_template);
      this.definition_menu = remote.Menu.buildFromTemplate(this.definition_menu_template);
      this._keyListener = function(e){
        if((e.ctrlKey || e.metaKey) && e.key === 'c'){
          e.preventDefault();
          const selectedText = window.getSelection();
          const text = selectedText.toString();
          if(text.length > 0){
            remote.clipboard.writeText(text);
          }
        }
      }
      document.addEventListener('keydown', this._keyListener);
    },
    beforeUnmount() {
      document.removeEventListener('keydown', this._keyListener);
    },
    computed: {
      chounnatLexical(){
        return this.$store.state.chounnatLexical
      },
      khmerDictionary(){
        return this.$store.state.khmerDictionary
      }
    },
    methods: {
      onSearchWord: function(){
        DictionaryController.onSearch(this.search)
      },
      onClearSearch: function(){
        this.search = '';
        DictionaryController.onSearch('');
      },
      onClickChounnatDictionary: async function(value) {
        this.chounnatDetail = await DictionaryController.onOpenChounNatDetail(value.writtenForm);
        this.updateCheckBookmark();
      },
      onClickKhmerDictionary: async function(value) {
        this.khmerDcitionaryDetail = await DictionaryController.onOpenKhmerDictionaryDetail(value.t_id);
        this.updateCheckBookmark();
      },
      getKhmerNumber: function(subscript){
        return DictionaryController.getKhmerNumber(subscript)
      },
      onClickBookmark: function(){
        this.$router.push('/bookmark');
        this.onClearSearch();
      },
      onToogleBookmark: function(data){
        let self = this;
         BookmarkController.toggleBookmark(data,function(){
          self.updateCheckBookmark();
         })
      },
      updateCheckBookmark: async function(){
        if(this.tab == 'first' && this.chounnatDetail){
          const writtenForm = this.chounnatDetail[0].writtenForm
          this.checkBookmark = await BookmarkController.isBookmark(writtenForm)
        }else if(this.tab == 'second' && this.khmerDcitionaryDetail){
          const t_id = this.khmerDcitionaryDetail[0].t_id
          this.checkBookmark = await BookmarkController.isBookmark(t_id)
        }else{
          this.checkBookmark = false
        }
        return this.checkBookmark
      },
      onCopyContextMenu: function(){
        const selectedText = window.getSelection();
        if(selectedText.toString().length > 0){
          this.definition_menu.popup(remote.getCurrentWindow())
        }
      },
      onInputContextMenu: function(){
        this.input_menu.getMenuItemById('copy').enabled = false
        this.input_menu.getMenuItemById('paste').enabled = false
        this.input_menu.getMenuItemById('selectAll').enabled = false
        const text = remote.clipboard.readText()
        if(text.length > 0){
          this.input_menu.getMenuItemById('paste').enabled = true
        }
        if(this.search.length > 0){
          this.input_menu.getMenuItemById('selectAll').enabled = true
          if(window.getSelection().toString().length > 0){
            this.input_menu.getMenuItemById('copy').enabled = true
          }
        }
        this.input_menu.popup(remote.getCurrentWindow())
      },
      textKeyDown: function(e){
        if((e.ctrlKey || e.metaKey) && e.key === 'v'){
          e.preventDefault();
          const text = remote.clipboard.readText()
          this.search  = text;
          DictionaryController.onSearch(text);
        }else if((e.ctrlKey || e.metaKey) && e.key === 'a'){
          let inputEl = this.$refs.searchInput.$el.querySelector('input')
          if(inputEl){
            inputEl.select();
          }
        }else if((e.ctrlKey || e.metaKey) && e.key === 'x'){
          const selectedText = window.getSelection();
          const text = selectedText.toString();
          if(text.length > 0){
            remote.clipboard.writeText(text);
            this.search  = '';
            DictionaryController.onSearch('');
          }
        }
      }
    }
}
</script>

<template>
  <VContainer :fluid="true" color="primary" class="dictionary-container">
    <VRow class="dictionary-body">
      <VCol :cols="4" class="dictionary-list">
        <VRow class="v-search-container">
          <v-toolbar class="v-search-toolbar khmerHanuman" color="primary">
            <v-text-field
              v-model="search"
              :loading="loading"
              bg-color="secondary"
              density="compact"
              variant="solo"
              label="Search"
              append-inner-icon="mdi-magnify"
              clear-icon="mdi-close-circle"
              clearable
              single-line
              hide-details
              shadow="false"
              flat="true"
              ref="searchInput"
              v-on:keydown="textKeyDown"
              @input="onSearchWord"
              @click:append-inner="onClick"
              @click:clear="onClearSearch"
              @contextmenu.prevent="onInputContextMenu()"
            ></v-text-field>
          <v-btn icon class="ml-2" @click="onClickBookmark">
            <v-icon color="#1CB1E7">mdi-bookmark</v-icon>
          </v-btn>
        </v-toolbar>
        </VRow>
        
        <VRow>
          <v-tabs v-model="tab">
            <v-tab class="khmerHanuman dictionary-tab-item rounded-t-lg" :variant="tab == 'first'?'tonal':'text'" value="first">សម្ដេចសង្ឃ ជួន ណាត</v-tab>
            <v-tab class="khmerHanuman dictionary-tab-item rounded-t-lg" rounded :variant="tab == 'second'?'tonal':'text'" value="second">វចនានុក្រមខ្មែរ</v-tab>
          </v-tabs>
        </VRow>
        <div class="dictionary-content" :class="{ 'd-none': tab != 'first' }">
          <div class="dictionary-wrapper">
              <RecycleScroller
                class="scroller"
                :items="chounnatLexical"
                :item-size="30"
                key-field="id"
              >
              <template #default="props">
                <div class="dictionary-word-item" :key="props.item.id" @click="onClickChounnatDictionary(props.item)">
                  <span class="khmerHanuman">{{ props.item.writtenForm }}</span>
                </div>
              </template>
              </RecycleScroller>
          </div>
        </div>
        <div class="dictionary-content" :class="{ 'd-none': tab != 'second' }">
          <div class="dictionary-wrapper">
              <RecycleScroller
                class="scroller"
                :items="khmerDictionary"
                :item-size="30"
                key-field="t_id"
              >
              <template #default="props">
                <div class="dictionary-word-item" :key="props.item.id" @click="onClickKhmerDictionary(props.item)">
                  <span v-if="props.item.t_level==1" class="khmerHanuman">{{ props.item.t_main }} <span v-if="props.item.t_subscrip" class="subcript">{{ getKhmerNumber(props.item.t_subscrip) }}</span></span>
                  <span v-else class="khmerHanuman"><span class="dictionary-sub-word-symbol">▶</span> {{ props.item.t_subword }}</span>
                </div>
              </template>
              </RecycleScroller>
          </div>
        </div>
      </VCol>
      
      <VCol :cols="8" class="dictionary-definition-body">
        <VRow>
          <v-toolbar color="secondary">
            <v-spacer></v-spacer>
            <v-toolbar-title>Definition</v-toolbar-title>
            <v-spacer></v-spacer>
            <v-btn v-if="tab == 'first' && chounnatDetail" icon @click="onToogleBookmark(chounnatDetail)">
              <v-icon v-if="checkBookmark">mdi-bookmark</v-icon>
              <v-icon v-else>mdi-bookmark-outline</v-icon>
            </v-btn>
            <v-btn v-else-if="tab == 'second' && khmerDcitionaryDetail" icon @click="onToogleBookmark(khmerDcitionaryDetail)">
              <v-icon v-if="checkBookmark">mdi-bookmark</v-icon>
              <v-icon v-else>mdi-bookmark-outline</v-icon>
            </v-btn>
          </v-toolbar>
          <v-divider></v-divider>
        </VRow>
        <div class="dictionary-definition-content">
          <div class="dictionary-definition-wrapper" ref="dictionaryDefinition" @contextmenu.prevent="onCopyContextMenu()">
            <ChounnatDetail v-if="tab == 'first' && chounnatDetail" :detail="chounnatDetail" />
            <KhmerDictionaryDetail v-else-if="tab == 'second' && khmerDcitionaryDetail" :detail="khmerDcitionaryDetail" />
            <div v-else class="empty-full-box">
              <v-icon size="x-large">mdi-book-open</v-icon>
            </div>
          </div>
        </div>
      </VCol>
    </VRow>
  </VContainer>
</template>


<style scoped>
  .dictionary-container{
    height: 100%;
    padding: 0px !important;
  }
  .dictionary-body{
    width: 100%;
    height: 100%;
    margin: 0px !important;
  }

  .dictionary-list{
    background: rgb(var(--v-theme-surface));
    color: rgb(var(--v-theme-on-surface));
    display: flex !important;
    flex-direction: column;
  }

  .dictionary-definition{
    background: rgb(var(--v-theme-surface));
    color: rgb(var(--v-theme-on-surface));
    display: flex !important;
    flex-direction: column;
  }

  .scroller {
    height: 100%;
    overflow: auto;
  }

  .dictionary-word-item {
    height: 30%;
    padding: 0 12px;
    display: flex;
    align-items: center;
    font-size: 20px;
  }
  .dictionary-word-item:hover {
    background: rgb(var(--v-theme-on-surface-variant));
    color: rgb(var(--v-theme-on-surface));
  }
  .dictionary-sub-word-symbol{
    font-size: 16px;
  }
  .v-search-toolbar{
    padding-left: 15px;
  }
  .dictionary-tab-item{
    font-size: 18px;
    font-weight: bold;
  }
  .dictionary-content{
    margin-top: 12px;
    flex: 100% 1 1;
    position: relative;
    margin: 18px -4px 12px -12px;
  }
  .dictionary-wrapper{
    overflow: hidden;
    position: absolute;
    top: 0;
    bottom: 0;
    left: 0;
    right: 0;
  }


  .dictionary-definition-body{
    background: rgb(var(--v-theme-background));
    color: rgb(var(--v-theme-on-background));
    display: flex !important;
    flex-direction: column;
  }
  .dictionary-definition-content{
    margin-top: 12px;
    flex: 100% 1 1;
    position: relative;
    margin: 14px -12px -12px -12px;
  }
  .dictionary-definition-wrapper{
    overflow: hidden;
    position: absolute;
    top: 0;
    bottom: 0;
    left: 0;
    right: 0;
  }
  .empty-full-box{
    display: flex;
    width: 100%;
    height: 100%;
    justify-content: center;
    align-items: center;
  }
  .dictionary-body>i{
    font-size: 50px;
  }
</style>