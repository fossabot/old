<script setup>
import ChounnatDetail from './detail/ChounnatDetail.vue';
import KhmerDictionaryDetail from './detail/KhmerDictionaryDetail.vue';
</script>

<script>
import DictionaryController from '../../db/DictionaryController';
import BookmarkController from '@/db/BookmarkController';
const remote = window.require('@electron/remote');
export default {
    name:'BookmarkView',
    data(){
      const self = this;
      return {
        search: '',
        checkBookmark: false,
        chounnatDetail: null,
        khmerDcitionaryDetail: null,
        loading: false,
        input_menu_template:
          [
            {
              label: 'Copy',
              id: 'copy',
              click: function () {
                const selectedText = window.getSelection();
                const text = selectedText.toString();
                if(text.length > 0){
                  remote.clipboard.writeText(text);
                }
              }
            },
            {
              label: 'Paste',
              id: 'paste',
              click: function () {
                const text = remote.clipboard.readText()
                self.search  = text;
                BookmarkController.onSearchBookmark(self.search);
              }
            },
            {
              label: 'Select All',
              id: 'selectAll',
              click: function () {
                let inputEl = self.$refs.searchInput.$el.querySelector('input')
                if(inputEl){
                  inputEl.select();
                }
              }
            }
          ],
          definition_menu_template:
          [
            {
              label: 'Copy',
              id: 'copy',
              click: function () {
                const selectedText = window.getSelection();
                const text = selectedText.toString();
                if(text.length > 0){
                  remote.clipboard.writeText(text);
                }
              }
            }
          ]
      }
    },
    mounted() {
      BookmarkController.query();
      this.input_menu = remote.Menu.buildFromTemplate(this.input_menu_template);
      this.definition_menu = remote.Menu.buildFromTemplate(this.definition_menu_template);
      this._keyListener = function(e){
        if((e.ctrlKey || e.metaKey) && e.key === 'c'){
          e.preventDefault();
          const selectedText = window.getSelection();
          const text = selectedText.toString();
          if(text.length > 0){
            remote.clipboard.writeText(text);
          }
        }
      }
      document.addEventListener('keydown', this._keyListener);
    },
    beforeUnmount() {
      document.removeEventListener('keydown', this._keyListener);
    },
    computed: {
      bookmarkList(){
        return this.$store.state.bookmarkList;
      }
    },
    methods: {
      onSearchBookmark: function(){
        BookmarkController.onSearchBookmark(this.search)
      },
      onClearSearch: function(){
        this.search = '';
        BookmarkController.onSearchBookmark('');
      },
      onClickOpenDictionary: async function(value){
        if(value.dictionaryName == 'chounnat'){
          this.chounnatDetail = await DictionaryController.onOpenChounNatDetail(value.content_id);
          this.khmerDcitionaryDetail = null;
          this.updateCheckBookmark();
        }else{
          this.khmerDcitionaryDetail = await DictionaryController.onOpenKhmerDictionaryDetail(value.content_id);
          this.chounnatDetail = null;
          this.updateCheckBookmark();
        }
      },
      getKhmerNumber: function(subscript){
        return DictionaryController.getKhmerNumber(subscript)
      },
      onClickBack: function(){
        this.$router.go(-1)
      },
      onToogleBookmark: function(data){
        let self = this;
        BookmarkController.toggleBookmark(data, function(result){
          if(result === false){
            self.khmerDcitionaryDetail = null;
            self.chounnatDetail = null;
          }
        });
      },
      updateCheckBookmark: async function(){
        if(this.chounnatDetail){
          const writtenForm = this.chounnatDetail[0].writtenForm
          this.checkBookmark = await BookmarkController.isBookmark(writtenForm)
        }else if(this.khmerDcitionaryDetail){
          const t_id = this.khmerDcitionaryDetail[0].t_id
          this.checkBookmark = await BookmarkController.isBookmark(t_id)
        }else{
          this.checkBookmark = false
        }
      },
      onCopyContextMenu: function(){
        const selectedText = window.getSelection();
        if(selectedText.toString().length > 0){
          this.definition_menu.popup(remote.getCurrentWindow())
        }
      },
      onInputContextMenu: function(){
        this.input_menu.getMenuItemById('copy').enabled = false
        this.input_menu.getMenuItemById('paste').enabled = false
        this.input_menu.getMenuItemById('selectAll').enabled = false
        const text = remote.clipboard.readText()
        if(text.length > 0){
          this.input_menu.getMenuItemById('paste').enabled = true
        }
        if(this.search.length > 0){
          this.input_menu.getMenuItemById('selectAll').enabled = true
          if(window.getSelection().toString().length > 0){
            this.input_menu.getMenuItemById('copy').enabled = true
          }
        }
        this.input_menu.popup(remote.getCurrentWindow())
      },
      textKeyDown: function(e){
        if((e.ctrlKey || e.metaKey) && e.key === 'v'){
          e.preventDefault();
          const text = remote.clipboard.readText()
          this.search  = text;
          BookmarkController.onSearchBookmark(text);
        }else if((e.ctrlKey || e.metaKey) && e.key === 'a'){
          let inputEl = this.$refs.searchInput.$el.querySelector('input')
          if(inputEl){
            inputEl.select();
          }
        }else if((e.ctrlKey || e.metaKey) && e.key === 'x'){
          const selectedText = window.getSelection();
          const text = selectedText.toString();
          if(text.length > 0){
            remote.clipboard.writeText(text);
            this.search  = '';
            BookmarkController.onSearchBookmark('');
          }
        }
      }
    }
}
</script>

<template>
  <transition>
  <VContainer :fluid="true" color="primary" class="dictionary-container">
    <VRow class="dictionary-body">
      <VCol :cols="4" class="dictionary-list">
        <VRow class="v-search-container">
          <v-toolbar class="v-search-toolbar khmerHanuman pr-2" color="primary">
            <v-btn
              icon
              class="hidden-xs-only mr-2"
              @click="onClickBack">
              <v-icon>mdi-arrow-left</v-icon>
            </v-btn>
            <v-text-field
              v-model="search"
              :loading="loading"
              bg-color="secondary"
              density="compact"
              variant="solo"
              label="Search"
              append-inner-icon="mdi-magnify"
              clear-icon="mdi-close-circle"
              clearable
              single-line
              hide-details
              shadow="false"
              flat="true"
              ref="searchInput"
              v-on:keydown="textKeyDown"
              @input="onSearchBookmark"
              @click:append-inner="onClick"
              @click:clear="onClearSearch"
              @contextmenu.prevent="onInputContextMenu()"
            ></v-text-field>
        </v-toolbar>
        </VRow>
        
        <div class="dictionary-content">
          <div class="dictionary-wrapper">
              <RecycleScroller
                class="scroller"
                :items="bookmarkList"
                :item-size="35"
                key-field="content_id"
              >
                <template #default="props">
                  <div class="dictionary-word-item" :key="props.item.content_id" @click="onClickOpenDictionary(props.item)">
                    <span class="khmerHanuman">{{ props.item.content }} <span v-if="props.item.subscript" class="subcript">{{ getKhmerNumber(props.item.subscript) }}</span></span>
                  </div>
                </template>
              </RecycleScroller>
          </div>
        </div>
      </VCol>
      
      <VCol :cols="8" class="dictionary-definition-body">
        <VRow>
          <v-toolbar color="secondary">
            <v-spacer></v-spacer>
            <v-toolbar-title>Definition</v-toolbar-title>
            <v-spacer></v-spacer>
            <v-btn v-if="chounnatDetail" icon @click="onToogleBookmark(chounnatDetail)">
              <v-icon v-if="checkBookmark">mdi-bookmark</v-icon>
              <v-icon v-else>mdi-bookmark-outline</v-icon>
            </v-btn>
            <v-btn v-else-if="khmerDcitionaryDetail" icon @click="onToogleBookmark(khmerDcitionaryDetail)">
              <v-icon v-if="checkBookmark">mdi-bookmark</v-icon>
              <v-icon v-else>mdi-bookmark-outline</v-icon>
            </v-btn>
          </v-toolbar>
          <v-divider></v-divider>
        </VRow>
        <div class="dictionary-definition-content">
          <div class="dictionary-definition-wrapper" @contextmenu.prevent="onCopyContextMenu()">
            <ChounnatDetail v-if="chounnatDetail" :detail="chounnatDetail" />
            <KhmerDictionaryDetail v-else-if="khmerDcitionaryDetail" :detail="khmerDcitionaryDetail" />
            <div v-else class="empty-full-box">
              <v-icon size="x-large">mdi-bookmark</v-icon>
            </div>
          </div>
        </div>
      </VCol>
    </VRow>
  </VContainer>
</transition>
</template>


<style scoped>
  .dictionary-container{
    height: 100%;
    padding: 0px !important;
  }
  .dictionary-body{
    width: 100%;
    height: 100%;
    margin: 0px !important;
  }

  .dictionary-list{
    background: rgb(var(--v-theme-surface));
    color: rgb(var(--v-theme-on-surface));
    display: flex !important;
    flex-direction: column;
  }

  .dictionary-definition{
    background: rgb(var(--v-theme-surface));
    color: rgb(var(--v-theme-on-surface));
    display: flex !important;
    flex-direction: column;
  }

  .scroller {
    height: 100%;
    overflow: auto;
  }

  .dictionary-word-item {
    height: 35%;
    padding: 0 12px;
    display: flex;
    align-items: center;
    font-size: 20px;
  }
  .dictionary-word-item:hover {
    background: rgb(var(--v-theme-on-surface-variant));
    color: rgb(var(--v-theme-on-surface));
  }
  .dictionary-sub-word-symbol{
    font-size: 16px;
  }
  .v-search-toolbar{
    padding-left: 0px;
  }
  .dictionary-tab-item{
    font-size: 18px;
    font-weight: bold;
  }
  .dictionary-content{
    margin-top: 12px;
    flex: 100% 1 1;
    position: relative;
    margin: 18px -4px 12px -12px;
  }
  .dictionary-wrapper{
    overflow: hidden;
    position: absolute;
    top: 0;
    bottom: 0;
    left: 0;
    right: 0;
  }


  .dictionary-definition-body{
    background: rgb(var(--v-theme-background));
    color: rgb(var(--v-theme-on-background));
    display: flex !important;
    flex-direction: column;
  }
  .dictionary-definition-content{
    margin-top: 12px;
    flex: 100% 1 1;
    position: relative;
    margin: 14px -12px -12px -12px;
  }
  .dictionary-definition-wrapper{
    overflow: hidden;
    position: absolute;
    top: 0;
    bottom: 0;
    left: 0;
    right: 0;
  }

  .empty-full-box{
    display: flex;
    width: 100%;
    height: 100%;
    justify-content: center;
    align-items: center;
  }
</style>