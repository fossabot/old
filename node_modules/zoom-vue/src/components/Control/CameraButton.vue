<template>
    <div class="camera-button" :class="{active: !isVideoMute}">
        <IconMeetingMuteVideo v-if="isVideoMute" @click="toggleVideo"/>
        <div v-else class="active-camera">
            <IconMeetingUnMuteVideo  @click="toggleVideo"/>
            <v-menu>
            <template v-slot:activator="{ props }">
                <v-btn
                    icon="mdi-apple-keyboard-control"
                    color="#474747"
                    size="x-small"
                    v-bind="props"
                ></v-btn>
            </template>
            <v-list>
                <v-list-subheader>Select a camera</v-list-subheader>
                <v-list-item
                    v-for="(item, index) in cameraList"
                    :key="index"
                    :value="index"
                    :active="activeDeviceId == item.deviceId"
                    active-color="primary"
                    @click="onClickCamera(item)">
                    <v-list-item-title>{{ item.label }}</v-list-item-title>
                </v-list-item>
                <v-list-subheader>Option</v-list-subheader>
                <v-list-item
                    key="mirror"
                    value="mirror"
                    :active="isMirror"
                    active-color="primary"
                    @click="onClickMirror">
                    <v-list-item-title>Mirror My video</v-list-item-title>
                </v-list-item>
            </v-list>
            </v-menu>
        </div>
    </div>
</template>

<script>
import ZoomController from '../../ZoomController'
import IconMeetingUnMuteVideo from '../Icon/IconMeetingUnMuteVideo.vue'
import IconMeetingMuteVideo from '../Icon/IconMeetingMuteVideo.vue'
import { VideoCapturingState } from '@zoom/videosdk';
export default {
    components: {IconMeetingUnMuteVideo,IconMeetingMuteVideo},
    emits: ["onToastMessage"],
    data(){
        return {
            isVideoMute: true,
            isMirror: false,
            selectCamera: null,
            activeDeviceId: null,
            cameraList: []
        }
    },
    watch:{
        selectCamera(val){
            if(val){
                this.switchCamera(val.deviceId)
            }
        },
        isVideoMute(val){
            if(val === false){
                this.cameraList = ZoomController.zoomClient.getMediaStream().getCameraList()
            }
        }
    },
    mounted(){
        ZoomController.zoomClient.on('video-capturing-change', this.onVideoCaptureChange);
        
    },
    unmounted(){
        ZoomController.zoomClient.off('video-capturing-change', this.onVideoCaptureChange);
    },
    methods:{
        async toggleVideo(){
            try {
                await ZoomController.toggleVideo()
                this.activeDeviceId = ZoomController.zoomClient.getMediaStream().getActiveCamera()
            } catch (error) {
                this.$emit("onToastMessage", "Turn on/off video failed. " + error.message)
            }
        },
        async switchCamera(deviceId){
            try {
                await ZoomController.zoomClient.getMediaStream().switchCamera(deviceId)
                this.activeDeviceId = deviceId
            } catch (error) {
                this.$emit("onToastMessage", "Switch camera failed. " + error.message)   
            }
        },
        onVideoCaptureChange(payload){
            try {
                if (payload.state === VideoCapturingState.Started) {
                    this.isVideoMute = false;
                } else {
                    this.isVideoMute = true;
                }
            } catch (error) {
                console.log("onVideoCaptureChange", error)
            }
        },
        onClickCamera(val){
            this.selectCamera = val
        },
        async onClickMirror(){
            try {
                let mirror = !this.isMirror
                await ZoomController.zoomClient.getMediaStream().mirrorVideo(mirror)
                this.isMirror = mirror
            } catch (error) {
                this.$emit("onToastMessage", "Mirror video failed. " + error.message)   
            }
        }
    }
    
}
</script>
<style lang="scss" scoped>
    .camera-button{
        width: 44px;
        transition: width 0.3s ease;
        &.active{
            width: 100px;
        }
        .active-camera{
            width: 100px;
            background: rgba(225, 225, 225, 0.15);
            border-radius: 15px;
            border-radius: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-right: 10px;
        }
    }
</style>