<template>
    <div class="sharescreen-button" :class="{active: (isSharingScreen && isEnableAudio)}">
        <IconMeetingShare v-if="!isSharingScreen" @click="toggleClickShare" />
        <IconMeetingStopShare v-else-if="!isEnableAudio" @click="toggleClickShare"/>
        <div v-else class="active-sharescreen">
            <IconMeetingStopShare @click="toggleClickShare"/>
            <v-btn
                v-if="isSharingAudio"
                icon="mdi-volume-high"
                color="#474747"
                size="x-small"
                @click="toggleShareAudio"
                ></v-btn>
            <v-btn
                v-else
                icon="mdi-volume-mute"
                color="#474747"
                size="x-small"
                @click="toggleShareAudio"
            ></v-btn>
        </div>
        <ShareScreenDialog :show="showShareScreenDialog" @onCloseDialogShareScreen="onCloseDialogShareScreen" @onSelectedShareScreen="onSelectedShareScreen" ref="shareDialog"/>
        <video v-if="isSupportWebCodecs()" class="my-screen-share" height="10" width="10" ref="selfShareCanvas"></video>
        <canvas v-else class="my-screen-share" height="10" width="10" ref="selfShareCanvas"></canvas>
    </div>
</template>

<script>
import ZoomController from '../../ZoomController'
import { isSupportWebCodecs } from '../../utils/platform'
import IconMeetingShare from '../Icon/IconMeetingShare.vue'
import IconMeetingStopShare from '../Icon/IconMeetingStopShare.vue'
import ShareScreenDialog from '../../components/Sharescreen/ShareScreenDialog.vue'
const remote = window.require('@electron/remote')
const desktopCapturer = remote.desktopCapturer
const os = window.require('os');
const { exec } = window.require('child_process');
export default {
    components: {IconMeetingShare,IconMeetingStopShare,ShareScreenDialog},
    emits: ["onToastMessage"],
    data(){
        return {
            showShareScreenDialog: false,
            isSharingScreen: false,
            isSharingAudio: false,
            isEnableAudio: false,
            isMuteMicByUser: false
        }
    },
    computed:{
      isUserShareScreen(){
        return this.$store.state.userShareScreen != null
      }
    },
    mounted(){
        ZoomController.zoomClient.on("share-audio-change",this.onShareAudioChange)
    },
    unmounted(){
        ZoomController.zoomClient.off("share-audio-change",this.onShareAudioChange)
    },
    methods: {
        isMac(){
            return os.platform() == 'darwin'
        },
        isSupportWebCodecs(){
            return isSupportWebCodecs()
        },
        async onShareAudioChange(payload){
            if (payload.state === 'on') {
                this.isSharingAudio = true
                console.log('Switched audio source to Share Chrome Tab Audio')
            } else if(payload.state === 'off') {
                this.isSharingAudio = false
                console.log('Switched audio source to your microphone')
            }
        },
        async toggleShareAudio(){
            await ZoomController.toggleMuteShareAudio(this.isSharingAudio, this.isMuteMicByUser)
            this.emitter.emit("onMuteShareScreenAudio",{'muteShareAudioByUser': !this.isSharingAudio})
        },
        async toggleClickShare(){
            try {
                if(ZoomController.zoomClient.getMediaStream().isShareLocked()){
                    this.$emit("onToastMessage", "Share is locked by host.")
                    return
                }
                if(this.isUserShareScreen){
                    this.$emit("onToastMessage", "Someone is sharing screen.")
                    return
                }
                const hasPermission = await this.checkScreenRecord()
                if(hasPermission){
                    if(this.isSharingScreen){
                        await ZoomController.zoomClient.getMediaStream().stopShareScreen()
                        this.isSharingScreen = false
                    }else{
                        this.showShareScreenDialog = true
                    }
                }else if(this.isMac()){
                    //ask to allow
                    //osxBundleId appid
                    const appId = ZoomController.appId
                    await exec('tccutil reset ScreenCapture ' + appId);
                    setTimeout(() => {
                        desktopCapturer.getSources({types: ["window", "screen"]}).then(sources => {
                            this.openSystemPreferences()
                        }).catch(error =>{
                            this.openSystemPreferences()
                        })
                    }, 1000);
                    // setTimeout(() => {
                    //     this.openSystemPreferences()
                    // }, 1000);
                }
            } catch (error) {
                console.log("toggleClickShare",error)
            }
        },
        onCloseDialogShareScreen(){
            this.showShareScreenDialog = false
        },
        async onSelectedShareScreen(data){
            try {
                const selectedSourceId = data.selectedSourceId
                this.isEnableAudio = data.isEnableAudio
                this.showShareScreenDialog = false
                await ZoomController.toggleVideo(true)
                await this.setSelectedShareScreenMedia(selectedSourceId, this.isEnableAudio)
                await ZoomController.zoomClient.getMediaStream().startShareScreen(this.$refs.selfShareCanvas)
                this.isSharingScreen = true
            } catch (error) {
                console.log("Sharescreen-error", error)
            }
                
        },
        setSelectedShareScreenMedia(sourceId, isEnableAudio){
            return new Promise((resolve)=>{
                try{
                    navigator.mediaDevices.getDisplayMedia = async () => {
                        // create MediaStream
                        if(isEnableAudio){
                            const stream = await navigator.mediaDevices.getUserMedia({
                                audio: {
                                    mandatory: {
                                        chromeMediaSource: 'desktop'
                                    }
                                },
                                video: {
                                    mandatory: {
                                        chromeMediaSource: "desktop",
                                        chromeMediaSourceId: sourceId,
                                        minWidth: 1280,
                                        maxWidth: 1280,
                                        minHeight: 720,
                                        maxHeight: 720,
                                    },
                                }
                            });
                            return stream;
                        }else{
                            const stream = await navigator.mediaDevices.getUserMedia({
                                audio: false,
                                video: {
                                    mandatory: {
                                        chromeMediaSource: "desktop",
                                        chromeMediaSourceId: sourceId,
                                        minWidth: 1280,
                                        maxWidth: 1280,
                                        minHeight: 720,
                                        maxHeight: 720,
                                    },
                                }
                            });
                            return stream;
                        }
                    };
                    resolve(true)
                }catch(ex){
                    console.log("setSelectedShareScreenMedia", ex)
                    resolve(false)
                }
            }); 
        },
        checkScreenRecord: function () {
            return new Promise(async(resolve)=>{
                try {
                    if(os.platform() == 'darwin' && remote.systemPreferences.getMediaAccessStatus('screen') != 'granted'){
                        resolve(false)
                    }else{
                        resolve(true);
                    }
                } catch (error) {
                    resolve(false)
                }
            });
        },
        openSystemPreferences(pane ="security", section = "Privacy_ScreenCapture"){
            remote.shell.openExternal(`x-apple.systempreferences:com.apple.preference.${pane}${section ? `?${section}` : ''}`);
        }
    }
}
</script>

<style lang="scss" scoped>
  .my-screen-share{
    display: none;
    position: absolute;
    top: 50px;
    z-index: 1000;
    transition: ease 0.5s;
  }
.sharescreen-button{
    width: 44px;
    transition: width 0.3s ease;
    &.active{
        width: 100px;
    }
    .active-sharescreen{
        width: 100px;
        background: rgba(225, 225, 225, 0.15);
        border-radius: 15px;
        border-radius: 15px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding-right: 10px;
    }
}
</style>