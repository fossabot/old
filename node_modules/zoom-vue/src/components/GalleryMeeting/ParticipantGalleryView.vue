<template>
    <div class="participant-container" :class="{hidden: !isGridView}">
        <Pagination :page="this.page" :totalPage="this.totalPage" @toNextPage="toNextPage" @toPreviousPage="toPreviousPage" />
        <canvas id="canvas-gallery" class="canvas-gallery" width="800" height="600" ref="canvasGallery" />
        <ul class="avatar-list">
            <template v-for="(item, index) in this.pageParticipants" :key="item.userId">
                <template v-if="this.layoutGG[index] && this.layoutGG[index].width">
                <UserCard :bVideoOn="item.bVideoOn" :reactions="reactions" :user="item" :muted="item.muted" :displayName="item.displayName" :index='index' :width="this.layoutGG[index].width" :height="this.layoutGG[index].height" :top="`${this.canvasUserHeight - this.layoutGG[index].y - this.layoutGG[index].height}`" :left="this.layoutGG[index].x" />
                </template>
            </template>
            
        </ul>
    </div>
    
</template>
<script>
import Pagination from './Pagination.vue'
import UserCard from './../UserCard.vue'
import ZoomController from '../../ZoomController'
import { debounce } from '../../assets/js/util'
import { getVideoLayout,maxViewportVideoCounts } from '../../utils/VideoLayoutHelper'
const MAX_NUMBER_PER_PAGE = 9;
export default {
    components: {Pagination, UserCard},
    props:['reactions','isGridView'],
    data() {
        return {
            ro: null,
            page: 0,
            totalPage: 0,
            pageParticipants: [],
            layoutGG: [],
            canvasUserHeight: 0,
        }
    },
    watch:{
        page(page){
            console.log("page-gg", page)
        },
        isShow(val){
            let sefl = this
            console.log("watch-isgrid", val)
            if(val){
                setTimeout(() => {
                    sefl.onResize()
                }, 100);
            }else{
                this.unsubscriveVideos()
            }
        }
    },
    mounted() {
        this.ro = new ResizeObserver(debounce(this.onResize,100))
        this.ro.observe(this.$refs.canvasGallery)
        ZoomController.zoomClient.on('user-added', this.onUserAdded)
        ZoomController.zoomClient.on('user-removed', this.onUserRemoved)
        ZoomController.zoomClient.on('user-updated', this.onUserUpdated)
    },
    beforeUnmount() {
        this.ro.unobserve(this.$refs.canvasGallery)
    },
    async unmounted() {
        ZoomController.zoomClient.off('user-added', this.onUserAdded)
        ZoomController.zoomClient.off('user-removed', this.onUserRemoved)
        ZoomController.zoomClient.off('user-updated', this.onUserUpdated)
        //await this.unsubscriveVideos()
    },
    methods: {
        async renderUserVideo(videoParticipants, size){
            if(!this.isGridView) return
            const width = this.$refs.canvasGallery.offsetWidth;
            const height = this.$refs.canvasGallery.offsetHeight;
            this.canvasUserHeight = height;
            //console.log("render", width, height, videoParticipants)
            let layouts = getVideoLayout(width, height, size);
            await this.unsubscriveVideos();
            this.layoutGG = [...layouts]
            for(const i in videoParticipants){
                const userId = videoParticipants[i];
                const layout = layouts[i];
                console.log("renderUserVideo", userId, layout)
                await ZoomController.zoomClient.getMediaStream().renderVideo(this.$refs.canvasGallery, userId, layout.width, layout.height, layout.x, layout.y, layout.quality,`gallery-${userId}`)
            }
        },
        async unsubscriveVideo(payload){
            return new Promise(async(resolve)=>{
                try {
                    console.log("unsubscriveVideo-1", payload);
                    for(const user of payload){
                        await ZoomController.zoomClient.getMediaStream().stopRenderVideo(this.$refs.canvasGallery, user.userId,`gallery-${user.userId}`)
                    }
                    resolve(true)
                } catch (error) {
                    resolve(true)
                }
            });
        },
        async unsubscriveVideos(){
            return new Promise(async(resolve)=>{
                try {
                    const participants = ZoomController.zoomClient.getAllUser();
                    for(const user of participants){
                        try {
                            await ZoomController.zoomClient.getMediaStream().stopRenderVideo(this.$refs.canvasGallery, user.userId,`gallery-${user.userId}`)
                            console.log("unsubscriveVideo", user)
                        } catch (error) {
                            console.log("unsubscriveVideo-in", error)
                        }
                    }
                    resolve(true)
                } catch (error) {
                    console.log("unsubscriveVideo", error)
                    resolve(true)
                }
            });
            
        },
        onUserAdded(payload){
            if(this.isGridView){
                this.onResize()
            }
            
        },
        async onUserRemoved(payload){
            try {
                for(const user of payload){
                    try {
                        await ZoomController.zoomClient.getMediaStream().stopRenderVideo(this.$refs.canvasGallery, user.userId,`gallery-${user.userId}`)
                    } catch (ignore) {

                    }
                }
                if(this.isGridView){
                    this.onResize()
                }
            } catch (error) {
                
            }
        },
        onUserUpdated(payload){
            if(this.isGridView){
                this.onResize()
            }
        },
        async onResize(){
            if(!this.isGridView) return
            console.log('resize', this.$refs.canvasGallery.offsetHeight,",",this.$refs.canvasGallery.offsetWidth)
            const width = this.$refs.canvasGallery.offsetWidth;
            const height = this.$refs.canvasGallery.offsetHeight;
            const pageSize = Math.min(
                    MAX_NUMBER_PER_PAGE,
                    maxViewportVideoCounts(width, height),
                );
            const participants = ZoomController.zoomClient.getAllUser();
            const totalSize = participants.length;
            this.totalPage = Math.ceil(totalSize / pageSize);
            
            let size = pageSize;
            if (this.page === this.totalPage - 1) {
                size = Math.min(size, totalSize % pageSize || size);
            }

            if(this.page >= this.totalPage && this.totalPage>0){
                this.page = 0;
                await this.onResize()
                return
            }

            this.pageParticipants = [];
            if (participants.length === 1) {
                this.pageParticipants = participants;
            } else {
                this.pageParticipants = participants
                //.filter((user) => user.userId !== currentUser.userId)
                .sort((user1, user2) => Number(user2.bVideoOn) - Number(user1.bVideoOn));
                //pageParticipants.splice(1, 0, currentUser);
                this.pageParticipants = this.pageParticipants.filter(
                    (_user, index) => Math.floor(index / pageSize) === this.page,
                );
            }
            const videoParticipants = this.pageParticipants
            .filter((user) => user.bVideoOn)
            .map((user) => user.userId);
            console.log("Video-parts", videoParticipants)
            await this.renderUserVideo(videoParticipants, size)
            ZoomController.zoomClient.getMediaStream().updateVideoCanvasDimension(this.$refs.canvasGallery, width, height)
        },
        async toPreviousPage(){
            if (this.page > 0) {
                this.page = this.page - 1;
                await this.onResize()
            }
            console.log("toPreviousPage-gg", this.page,",",this.totalPage)
        },
        async toNextPage(){
            if (this.page < this.totalPage - 1) {
                this.page = this.page + 1;
                await this.onResize()
            }
            console.log("Next-gg", this.page,",",this.totalPage)
        }
    },
}
</script>

<style lang="scss" scoped>
    .participant-container{
        width: 100%;
        height: 100%;
        position: relative;
        &.hidden{
            display: none;
        }
        .avatar-list {
            position: absolute;
            top:0;
            left: 0;
            width: 100%;
            height: 100%;
            /* pointer-events: none; */
            overflow: hidden;
            padding: 0;
            margin: 0;
        }
    }
    .canvas-gallery{
        width: 100%;
        height: 100%;
    }
</style>