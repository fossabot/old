<template>
    <div class="main-active-meeting" :class="{hidden: !isActive}">
        <canvas id="canvas-active" class="canvas-active" width="800" height="600" ref="activeRef" />
    </div>
</template>

<script>
import { debounce } from '../../assets/js/util'
import ZoomController from '../../ZoomController';
export default {
    props:['user','isActive'],
    data(){
        return {
            ro: null,
            currentUser: null
        }
    },
    watch: {
        async user(val){
            if(val){
                if(this.currentUser && this.currentUser.userId != val.userId){
                   await ZoomController.zoomClient.getMediaStream().stopRenderVideo(this.$refs.activeRef, this.currentUser.userId) 
                }
                this.onResize()
                this.currentUser = val
            }
        },
        isActive(val){
            console.log("isActive", val)
            if(val){
              this.onResize()
            }else{
                if(this.currentUser){
                    ZoomController.zoomClient.getMediaStream().stopRenderVideo(this.$refs.activeRef, this.currentUser.userId) 
                }
            }
        }
    },
    mounted(){
        console.log("MeetingUserActive-mounted", this.user)
        this.ro = new ResizeObserver(debounce(this.onResize, 500))
        this.ro.observe(this.$refs.activeRef)
        this.onResize()
    },
    beforeUnmount(){
        this.ro.unobserve(this.$refs.activeRef)
        if(this.user){
           ZoomController.zoomClient.getMediaStream().stopRenderVideo(this.$refs.activeRef, this.user.userId) 
        }
    },
    unmounted(){
        console.log("MeetingUserActive-unmounted", this.user)
        if(this.user){
           ZoomController.zoomClient.getMediaStream().stopRenderVideo(this.$refs.activeRef, this.user.userId) 
        }
    },
    methods:{
        async onResize(){
            if(this.user && this.isActive){
                const width = this.$refs.activeRef.offsetWidth;
                const height = this.$refs.activeRef.offsetHeight;
                console.log("onResizeUserActive", width, height, this.user)
                await ZoomController.zoomClient.getMediaStream().stopRenderVideo(this.$refs.activeRef, this.user.userId)
                if(this.user.bVideoOn){
                   await ZoomController.zoomClient.getMediaStream().renderVideo(this.$refs.activeRef, this.user.userId, width, height, 0, 0, 1) 
                }
                ZoomController.zoomClient.getMediaStream().updateVideoCanvasDimension(this.$refs.activeRef, width, height)
            }
        }
    }
}
</script>

<style lang="scss" scoped>
    .main-active-meeting{
        width: 100%;
        height: 100%;
        &.hidden{
            display: none;
        }
        .canvas-active{
          width: 100%;
          height: 100%;
          float: left;
          &.hidden{
            display: none;
          }
        }
    }
</style>