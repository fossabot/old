<template>
    <div class="main-share-meeting" :class="{hidden: !isShare}">
        <div class="share-container" ref="shareContainerRef">
            <div class="share-container-viewport" :style="{width: width +'px', height: height +'px'}">
                <canvas id="canvas-share" class="canvas-share" width="800" height="600" ref="shareRef" />
            </div>
        </div>
    </div>
</template>
<script>
import { debounce } from '../../assets/js/util'
import ZoomController from '../../ZoomController'
export default {
    props:['user','isShare'],
    data() {
        return {
            ro: null,
            shareDemension: null,
            currentUser: null,
            width: 0,
            height: 0
        }
    },
    watch:{
        user(val){
            if(val){
                this.currentUser = val
            }else{
                ZoomController.zoomClient.getMediaStream().stopShareView()
            }
        },
        isShare(val){
            if(val){
                if(!this.user) return
                ZoomController.zoomClient.getMediaStream().startShareView(this.$refs.shareRef, this.user.userId)
            }else{
                ZoomController.zoomClient.getMediaStream().stopShareView()
            }
        }
    },
    mounted() {
        this.ro = new ResizeObserver(debounce(this.onResize, 500))
        this.ro.observe(this.$refs.shareContainerRef)
        console.log("MeetingShare-mounted",this.user)
        ZoomController.zoomClient.on('share-content-dimension-change', this.onSharedContentDimensionChange)
        if(!this.user) return
        ZoomController.zoomClient.getMediaStream().startShareView(this.$refs.shareRef, this.user.userId)
    },
    beforeUnmount(){
        this.ro.unobserve(this.$refs.shareContainerRef)
    },
    unmounted() {
        console.log("MeetingShare-unmounted")
        ZoomController.zoomClient.off('share-content-dimension-change', this.onSharedContentDimensionChange)
        ZoomController.zoomClient.getMediaStream().stopShareView()
    },
    methods: {
        onSharedContentDimensionChange(payload){
            console.log("onSharedContentDimensionChange",payload)
            this.shareDemension = payload
            this.onResize()
        },
        onResize(){
            const width = this.shareDemension?.width || 0
            const height = this.shareDemension?.height || 0
            const containerWidth = this.$refs.shareContainerRef.offsetWidth;
            const containerHeight = this.$refs.shareContainerRef.offsetHeight;
            console.log("Share-onResize", width,height,containerWidth,containerHeight)
            const ratio = Math.min(containerWidth / width, containerHeight / height, 1);
            this.width = Math.floor(width * ratio),
            this.height = Math.floor(height * ratio)
        }
    },
}
</script>

<style lang="scss" scoped>
    .main-share-meeting{
      position: relative;
      padding: 5vh 0 10vh;
      width: 100%;
      height: 100%;
      display: flex;
      &.hidden{
        display: none;
      }
      .share-container{
        display: flex;
        flex-grow: 1;
        justify-content: center;
        align-items: center;
        overflow: hidden;
        .share-container-viewport{
              display: inline-block;
              max-width: 100%;
            .canvas-share{
                width: 100%;
                height: 100%;
                &.hidden{
                    display: none;
                }
            }
        }
      }
  }
</style>