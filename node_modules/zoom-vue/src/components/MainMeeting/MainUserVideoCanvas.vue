<template>
    <div class="user-video-meeting" :class="{hidden: !isUserVideo}">
        <canvas class="canvas-user-video" width="800" height="600" ref="userVideoRef" />
    </div>
</template>

<script>
import { debounce } from '../../assets/js/util'
import ZoomController from '../../ZoomController';
export default {
    props:['user','isUserVideo'],
    data(){
        return {
            ro: null,
            activeVideo: false,
            currentUser: null
        }
    },
    computed:{
        
    },
    watch: {
        isPin(val){
            console.log("isPin",val,this.currentUser,this.user)
            let self = this
            if(val){
                this.currentUser = this.user
                setTimeout(() => {
                    self.onResize()
                }, 100);
            }else{
                if(this.currentUser){
                    ZoomController.zoomClient.getMediaStream().stopRenderVideo(this.$refs.userVideoRef, this.currentUser.userId,'pin') 
                }
            }
        },
        user(val){
            if(val){
                if(this.currentUser){
                    ZoomController.zoomClient.getMediaStream().stopRenderVideo(this.$refs.userVideoRef, this.currentUser.userId,'pin') 
                }
                if(val.bVideoOn){
                    this.onResize()
                }else{
                    ZoomController.zoomClient.getMediaStream().stopRenderVideo(this.$refs.userVideoRef, val.userId,'pin') 
                }
                this.currentUser = val
            }
        }
    },
    mounted(){
        console.log("MeetingUserPin-mounted", this.user)
        this.ro = new ResizeObserver(debounce(this.onResize,500))
        this.ro.observe(this.$refs.userVideoRef)
    },
    beforeUnmount(){
        this.ro.unobserve(this.$refs.userVideoRef)
        if(this.user){
           ZoomController.zoomClient.getMediaStream().stopRenderVideo(this.$refs.userVideoRef, this.user.userId,'pin') 
        }
    },
    unmounted(){
        console.log("MeetingUserPin-unmounted", this.user)
        if(this.user){
           ZoomController.zoomClient.getMediaStream().stopRenderVideo(this.$refs.userVideoRef, this.user.userId,'pin') 
        }
    },
    methods:{
        async onResize(){
            if(this.user && this.isUserVideo){
                const width = this.$refs.userVideoRef.offsetWidth;
                const height = this.$refs.userVideoRef.offsetHeight;
                console.log("onResizeUserPin", width, height)
                await ZoomController.zoomClient.getMediaStream().stopRenderVideo(this.$refs.userVideoRef, this.user.userId,"pin")
                if(this.user?.bVideoOn == true){
                    await ZoomController.zoomClient.getMediaStream().renderVideo(this.$refs.userVideoRef, this.user.userId, width, height, 0, 0, 1,"pin")
                }
                ZoomController.zoomClient.getMediaStream().updateVideoCanvasDimension(this.$refs.userVideoRef, width, height)
            }
        },
        userData(){
            if(!this.user) return null
            return ZoomController.zoomClient.getUser(this.user.userId);
        }
    }
}
</script>

<style lang="scss" scoped>
    .user-video-meeting{
        width: 100%;
        height: 100%;
        &.hidden{
            display: none;
        }
        .canvas-user-video{
          width: 100%;
          height: 100%;
          float: left;
          &.hidden{
            display: none;
          }
        }
    }
</style>