<template>
    <v-dialog
      v-model="isShow"
      style="min-width: 30%; max-width:60%;"
    >
      <v-card>
        <v-card-title>Share Screen</v-card-title>
        <v-card-text style="height: 300px;">
         <ScreenShareLayout :items="screenSources" @onSelectedShareScreen="onSelectedShareScreen"/>
        </v-card-text>
        
        <v-card-actions>
          <v-checkbox v-if="!isMac" label="Enable audio" v-model="isEnableAudio"></v-checkbox>
          <v-spacer></v-spacer>
          <v-btn
            color="primary"
            variant="text"
            :disabled="selectedSourceId == null"
            @click="onClickShare"
          >
            Share
          </v-btn>
          <v-btn
            color="green-darken-1"
            variant="text"
            @click="onCloseDialog"
          >
            Close
          </v-btn>
        </v-card-actions>
      </v-card>
    </v-dialog>
</template>
<script>
const { desktopCapturer, contextBridge } = window.require("@electron/remote")
const os = window.require('os');
import ScreenShareLayout from "./ScreenShareLayout.vue"
export default {
    components:{ScreenShareLayout},
    props: ['show'],
    emits: ["onCloseDialogShareScreen","onSelectedShareScreen"],
    data(){
        return {
            selectedSourceId: null,
            isShow: false,
            screenSources: [],
            isEnableAudio: false
        }
    },
    computed: {
      isMac(){
        return os.platform() == 'darwin'
      }
    },
    watch:{
        show(val){
            this.isShow = val
            if(val){
              this.isEnableAudio = false
              this.initDisplayShareScreen()
            }else{
              this.selectedSourceId = null
            }
        },
        isShow(val){
            if(!val){
                this.onCloseDialog()
            }
        }
    },
    methods: {
        onCloseDialog(){
            this.$emit("onCloseDialogShareScreen")
        },
        async initDisplayShareScreen(){
          const captureSources = await this.getDesktopCaptureSources({types: ["window", "screen"]})
          this.screenSources = captureSources
        },
        onSelectedShareScreen(sourceId){
            this.selectedSourceId = sourceId
        },
        onClickShare(){
          this.$emit("onSelectedShareScreen", { "selectedSourceId": this.selectedSourceId ,"isEnableAudio": this.isEnableAudio})
        },
        getDesktopCaptureSources(options) {
          return new Promise((resolve, reject) => {
            desktopCapturer.getSources(options).then(sources => {
              return resolve(sources.map(source => {
                return {
                  id: source.id,
                  name: source.name,
                  url: source.thumbnail.toDataURL()
                };
              }));
            });
          });
        }
    }
}
</script>

<style lang="scss" scoped>

</style>