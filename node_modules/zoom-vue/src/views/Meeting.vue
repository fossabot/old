<template>
    <Loading v-if="isLoading==true" :loadingText="loadingText" :isReload="isReload" key="Loading"></Loading>
    <div v-else class="meeting-layout">
        <div class="header-layout">
            <MeetingHeader class="meeting-header" />
        </div>
        <div class="body-layout">
            <div class="meeting">
                <div class="meeting-wrap meeting-max"> 
                    <div class="main-layout" :class="{'is-grid': isGridView}">
                        <MainMeeting :isMainView="!isGridView" />
                    </div>
                    <div class="grid-layout" :class="{'is-grid': isGridView}">
                        <ParticipantGalleryView :reactions="reactions" :isGridView="true"/>
                    </div>
                    <MeetingControl :isFocusWindow="isFocusWindow" :myselfInfo="myselfInfo" @onToastMessage="onToastMessage"/>
                </div>
                <MeetingToast v-if="isToastShown" :toastContent="toastContent" />
            </div>
        </div>
    </div>
</template>

<script>
import ZoomController from '../ZoomController'
import MeetingControl from '../components/Control/MeetingControl.vue'
import MeetingHeader from '../components/Header/MeetingHeader.vue'
import MeetingToast from '../components/MeetingToast.vue'
import ParticipantGalleryView from '../components/GalleryMeeting/ParticipantGalleryView.vue'
import MainMeeting from '../components/MainMeeting/MainMeeting.vue'
import Loading from '@/components/Loading.vue'
import { ConnectionState } from '@zoom/videosdk'
const { ipcRenderer } = window.require('electron')
export default {
    name: "MeetingView",
    components: {MeetingControl,MeetingHeader,ParticipantGalleryView,MainMeeting,MeetingToast, Loading},
    data() {
        return {
            isLoading: true,
            loadingText: "Joining Conference",
            isReload: false,
            joined: false,
            isFocusWindow: true,
            timer: null,
            reactionTimer: null,
            reactionMainTimer: null,
            isInputing: false,
            reactions:[],
            myselfInfo: {},
            isToastShown: false,
            toastContent: null,
            min: "10%",
            max: "90%"
        }
    },
    computed:{
        isGridView(){
            return this.$store.state.isGridView
        }
    },
    watch:{
        isGridView(val){
            if(val){
                this.min = "0%"
                this.max = "0%"
            }else{
                this.min = "10%"
                this.max = "90%"
            }
        },
        toastContent(val, oldVal) {
            const seft = this
            this.isToastShown = false
            this.$nextTick(() => {
                clearTimeout(this.timer)
                this.isToastShown = true
                this.timer = setTimeout(() => {
                    this.isToastShown = false
                    seft.toastContent = null
                }, 5000)
            })
        }
    },
    mounted() {
        this.focusWindown()
        //window.addEventListener('click',this.focusWindown)
        const self = this
        ipcRenderer.on("join-conference",(e,data)=>{
            if(data){
                self.joinConference(data)
            }
        })
        ipcRenderer.on("close-zoom-meeting", function(e, data){
            if(data){
                self.closeConference(data)
            }
        })
    }, 
    methods: {
        async joinConference(data){
            console.log("Joingg")
            this.isLoading = true
            this.loadingText = "Joining Conference"
            this.joined = await ZoomController.joinConference(data.jid, data.name, data.zoomId, data.messageId, data.isModerator, data.meetingSDKKey, data.meetingSDKSecret, data.appId)
            if(!this.joined){
                this.loadingText = "Join Conference Failed"
                this.isLoading = true
                this.isReload = true
                return
            }
            this.isLoading = false
            this.myselfInfo = ZoomController.zoomClient.getCurrentUserInfo()
            this.$store.commit('setUserActive', this.myselfInfo)
            const userSharingList = await ZoomController.zoomClient.getMediaStream().getShareUserList()
            if(userSharingList.length > 0){
                this.$store.commit('setUserShareScreen', userSharingList[0])
            }
            ZoomController.zoomClient.on('connection-change', this.onConnectionChange)
            ZoomController.zoomClient.on('command-channel-message',this.onReceiveEmoji);
            ZoomController.zoomClient.on('active-speaker',this.onActiveSpeaker)
            ZoomController.zoomClient.on('video-active-change',this.onActiveVideoChange)
            ZoomController.zoomClient.on('active-share-change',this.onShareScreenChange)
            ZoomController.zoomClient.on('peer-share-state-change',this.onShareStateChange)
            ZoomController.zoomClient.on('host-ask-unmute-audio',this.onHostAskToUnmute)
            //User
            ZoomController.zoomClient.on('user-added', this.onUserAdded)
            ZoomController.zoomClient.on('user-removed', this.onUserRemoved)
            ZoomController.zoomClient.on('user-updated', this.onUserUpdated)
        },
        async closeConference(data){
            try{
                const result = await ZoomController.closeConference(data.jid, data.zoomId)
                if(result){
                    ipcRenderer.send("onLeaveMeeting")
                }
            }catch(ex){
                console.log(ex)
            }
        },
        onConnectionChange(payload){
            this.isReload = false
            if(payload){
                if(payload.state === ConnectionState.Reconnecting){
                    this.isLoading = true
                    this.loadingText = "Conference Disconnected, Try to reconnect"
                }
                else if(payload.state === ConnectionState.Fail){
                    this.isLoading = true
                    this.isReload = true
                    this.loadingText = "Conference Disconnected"
                }
                else if(payload.state === ConnectionState.Connected){
                    this.isLoading = false
                }else if(payload.state === ConnectionState.Closed){
                    this.isLoading = true
                    this.loadingText = "Conference End."
                    ipcRenderer.send("onLeaveMeeting")
                }
            }
        },
        focusWindown(e){
            console.log("click-win")
            if (e && e.type && e.type === 'input') {
                this.isInputing = true
            }
            clearTimeout(this.timer)
            this.isFocusWindow = true;
            if (this.isInputing) {
                return
            }
            this.timer = setTimeout(()=>{
                this.isFocusWindow = false;
            },500)
        },
        onReceiveEmoji(payload){
            let senderId = payload.senderId;
            let senderName = payload.senderName;
            let text = payload.text;
            let cmdList = text.split('|')
            let type = cmdList.shift();
            if(type != '1') return
            let reaction = cmdList[0]
            if (reaction == 'raisehand') {
                let reactionObj = this.$store.state.cmdReactionMap
                if (reactionObj[senderId]) {
                    let newReaction = {
                        [senderId]: null
                    }
                    let newReactionObj = {...this.$store.state.cmdReactionMap, ...newReaction}
                    this.$store.commit('setReactionMap', newReactionObj)
                }
                let handStatus = {
                    [senderId]: {reaction, senderName}
                }
                let newRaisedHandObj = {...this.$store.state.cmdRaisedHandMap, ...handStatus}
                this.$store.commit('setRaisedHandMap', newRaisedHandObj)
                this.reactionMainTimer = setTimeout(() => {
                    let newMainReaction = {senderId,reaction,senderName}
                    this.$store.commit('setReactionMain', newMainReaction)
                    clearTimeout(this.reactionTimer1)
                    this.reactionTimer1 = setTimeout(() => {
                        let currentMainReaction = this.$store.state.reactionMain
                        if(currentMainReaction && currentMainReaction.senderId == senderId){
                           this.$store.commit('setReactionMain', null) 
                        }
                    }, 5000)
                }, 500);
            } else if (reaction == 'lowerhand') {
                let handStatus = {
                    [senderId]: null
                }
                let newRaisedHandObj = {...this.$store.state.cmdRaisedHandMap, ...handStatus}
                this.$store.commit('setRaisedHandMap', newRaisedHandObj)
            } else {
                clearTimeout(this.reactionTimer)
                clearTimeout(this.reactionMainTimer)
                let newReaction = {
                    [senderId]: {reaction, senderName}
                }
                let newReactionObj = {...this.$store.state.cmdReactionMap, ...newReaction}
                this.$store.commit('setReactionMap', newReactionObj)
                this.reactionTimer = setTimeout(() => {
                    let newReaction = {
                        [senderId]: null
                    }
                    newReactionObj = {...this.$store.state.cmdReactionMap, ...newReaction}
                    this.$store.commit('setReactionMap', newReactionObj)
                }, 5000)
                this.reactionMainTimer = setTimeout(() => {
                    let newMainReaction = {senderId,reaction,senderName}
                    this.$store.commit('setReactionMain', newMainReaction)
                    clearTimeout(this.reactionTimer1)
                    this.reactionTimer1 = setTimeout(() => {
                        let currentMainReaction = this.$store.state.reactionMain
                        if(currentMainReaction && currentMainReaction.senderId == senderId){
                           this.$store.commit('setReactionMain', null) 
                        }
                    }, 5000)
                }, 500);
            }
        },
        onActiveSpeaker(payload){
            console.log("active-speaker", payload)
            const map = {}
            for(const user of payload){
                map[user.userId] = user;
            }
            let newSpeakerMap = map
            console.log("new-active",newSpeakerMap,payload[0])
            let firstUser = payload[0]
            if(firstUser){
                let userData = ZoomController.zoomClient.getUser(firstUser.userId)
                this.$store.commit('setUserActive', userData)
            }
            this.$store.commit('setActiveSpeakerMap', newSpeakerMap)
        },
        onActiveVideoChange(payload){
            console.log("onActiveVideoChange",payload)
        },
        onShareScreenChange(payload){
            console.log("onShareScreenChange", payload)
            if(payload.state === 'Active'){
                this.$store.commit('setUserShareScreen', payload)
            }else if(payload.state === 'Inactive'){
                this.$store.commit('setUserShareScreen', null)
            }
        },
        onShareStateChange(payload){
            console.log("onShareStateChange", payload)
            if(payload.action === 'Start'){
                //this.$store.commit('setUserShareScreen', payload)
            }else if(payload.action === 'Stop'){
                this.$store.commit('setUserShareScreen', null)
            }
        },
        onHostAskToUnmute(payload){
            console.log("onHostAskToUnmute",payload)
            this.toastContent = "Host ask you to unmute."
        },
        onUserAdded(payload){
            
            
        },
        onUserRemoved(payload){
            try{
                let userPin = this.$store.state.userPin
                let userShareScreen = this.$store.state.userShareScreen
                let userActive = this.$store.state.userActive
                for(let user of payload){
                    if(userPin && userPin.userId == user.userId){
                        this.$store.commit('setUserPin', null)
                    }else if(userShareScreen && userShareScreen.userId == user.userId){
                        this.$store.commit('setUserShareScreen', null)
                    }else if(userActive && userActive.userId == user.userId){
                        this.$store.commit('setUserActive', this.myselfInfo)
                    }
                }
            }catch(ex){

            }
        },
        onUserUpdated(payload){
            let userPin = this.$store.state.userPin
            let userShareScreen = this.$store.state.userShareScreen
            let userActive = this.$store.state.userActive
            for(let user of payload){
                console.log("u-update", userPin, user)
                if(userPin && userPin.userId == user.userId){
                    let userData = ZoomController.zoomClient.getUser(user.userId)
                    this.$store.commit('setUserPin', userData)
                }else if(userShareScreen && userShareScreen.userId == user.userId){
                    let userData = ZoomController.zoomClient.getUser(user.userId)
                    this.$store.commit('setUserShareScreen', userData)
                }else if(userActive && userActive.userId == user.userId){
                    let userData = ZoomController.zoomClient.getUser(user.userId)
                    this.$store.commit('setUserActive', userData)
                }
            }
        },
        onToastMessage(message){
            this.toastContent = message
        }
    }
}
</script>

<style lang="scss" scoped>
    .main-layout{
        position: relative;
        width: 75%;
        height: 100%;
        float: left;
        &.is-grid{
            display: none;
        }
    }
    .grid-layout{
        position: relative;
        width: 25%;
        height: 100%;
        float: left;
        &.is-grid{
            width: 100%;
        }
    }
</style>
